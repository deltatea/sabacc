---
title: "Pure Sabacc: Using R and Monte Carlo simulation to solve the galaxy's greatest card game"
author: "Carter Richard"
date: "12/31/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stats)

```

*Sabacc* is an interesting bit of lore. It's steeped in the mythology of the *Star Wars* universe.  You might have heard of the game as Han Solo's method of choice for winning the *Millenium Falcon* from Lando Calrissian, but did you know that there are over 15 different variants of the galaxy's most popular card game?

I set out to build this analysis after thinking about an assignment from my undergraduate days. In that class (PHY 315: Computational Physics), one of our first projects was to build a simulation of the cardgame Blackjack. 

#Sabacc Rules

We're going to use the standard rules for Sabacc as published on http://sabacc.sourceforge.net/rules. Here's a quick breakdown of how it works:
  
  Sabacc is, simply explained, a hybrid of blackjack and poker. The game is played with a 76 card deck, which consists of four suits with values from 1-15 and additional set of face cards with values ranging from 0 to -17. The goal of the game is to achieve a hand with a total value as close to 23 or -23 as possible without going over.
  
  When a round begins, each player places initial bets and are dealt two cards. Players may then take turns either drawing an additional card or standing. The first four rounds of the game are the 'pot-building' phase, and no player may call the game at this time.
  
  After four rounds, any player may call the game. One final round of bets occurs at this time, and then all players reveal their cards.
  
  If a player has a hand greater than 23, less than -23, or exactly 0 has 'bombed out' and loses the hand. The player with the closest hand to the absolute value of 23 wins the pot - and if they have exactly 23 or -23 (called 'Pure Sabacc'), they also win the Sabacc pot. However, if a player claims 'Pure Sabacc' and another player has the 'Idiot's Array' (an Idiot, a 2 of any suit, and a 3 of any suit), they beat the 'Pure Sabacc' and claim both the pot and the Sabacc pot.
  
  This version of Sabacc also has rules for 'Sabacc shift', which is a random occurence in which all players cards are randomized. We'll talk about that more in the conclusions section.
  
#Theory

  I had a theory about Sabacc which I wanted to test. Since Blackjack is played against the dealer and Poker is played against other players, a game which mixes both might be capable of solution by statistical analysis. The key assumptions here are:
  * A Sabacc player will **always** draw cards to improve their hand - either they are comfortable with their hand value or they are not.
  * In Blackjack, you can infer the likely value of another player's hand simply based on the number of cards they have drawn. This is not useful in Blackjack since you are playing against the house - but in Sabacc *you are playing against other players*. We'll see later how this pays off.
  
Building the deck in Sabacc is not too difficult, but I broke it down into two parts. The first was constructing an array of values which correspond to the four suits of cards with value 1 to 15.

```{r}
suits1 <- c("Sabers", "Flasks", "Coins", "Staves")
cards1 <- c("One", "Two", "Three", "Four", "Five", "Six",
           "Seven", "Eight", "Nine", "Ten", "Eleven",
           "Commander", "Mistress", "Master", "Ace")
deck1 <- data.frame(suits1 = character(0), cards1 = character(0))

  for (i in suits1){
    for (j in cards1){
      deck1 <- rbind.data.frame(deck1, cbind.data.frame(j, i))
    }
  }

val1 <- rep(1:15, 4)
deck1 <- cbind(deck1, val1)
colnames(deck1) <- c("card", "suit", "val")
```

Then I build the part of the deck which correspond to face cards with values ranging from 0 to -17. 

```{r}
suits2 <- c("Face", "Face")
cards2 <- c("The Star", "The Evil One", "Moderation", "Demise",
            "Balance", "Endurance", "Queen of Air and Darkness",
            "Idiot")
deck2 <- data.frame(suits2 = character(0), cards2 = character(0))

  for (i in suits2){
    for (j in cards2){
      deck2 <- rbind.data.frame(deck2, cbind.data.frame(j, i))
    }
  }

val2 <- rep(c(-17, -15, -14, -13, -11, -8, -2, 0), 2)
deck2 <- cbind(deck2, val2)
colnames(deck2) <- c("card", "suit", "val")
```

Finally I simply binded each part of the deck together to yield our final Sabacc deck.

```{r}
deck <- rbind(deck1, deck2)

remove(cards1, cards2, i, j, suits1, suits2, val1, val2, deck1, deck2)
```

#Simulation

I thought it would be interesting to run a Monte Carlo simulation of draws from the Sabacc deck, and calculate the distribution of hand values for each additional card drawn. 

To do this, I first sampled 9 draws from the Sabacc deck (without replacement, because each round is separate) and calculated the cumulative sums of the hand after each draw. I then repeated this sampling for 10,000 rounds.

```{r}
uplim <- 10000
handlim <- 9
tot <- data.frame()

  for(i in 1:uplim){
    trial <- i
    draw <- deck[ sample(nrow(deck), handlim, replace = FALSE), 3]
    val <- cumsum(draw)
    hand <- 1:handlim
    add <- cbind(trial, hand, draw, val)
    tot <- rbind(tot, add)
  }
```




I then took the results from this simulation and plotted the probability distributions of the player's hand value by the number of cards they had drawn.

```{r}

ggplot(tot, aes(x = val, fill = as.character(hand))) +
  geom_density(alpha = 0.2) +
  geom_vline(xintercept = 27, linetype = "dashed", color = "red") + 
  geom_vline(xintercept = -27, linetype = "dashed", color = "red") +
  labs(title = "Hand value likelihood by number of cards drawn in Sabacc",
       caption = "n = 10,000 hands",
       fill = "Cards drawn")

```


Interesting! What we find is that a player is *most* likely to achieve 'Perfect Sabacc' after drawing only **three** cards. Four cards is still pretty likely, but not as much as three, and every card drawn after is less and less likely. 

#Conclusion

What does this mean? A couple of things. 

First - Pure Sabacc is most likely to be achieved after **three** card draws, and comparatively unlikely to be achieved after two or four card draws. This means you should *probably* stand at least one round of the 'pot-building' phase.

Second (and perhaps most importantly) - you should **never** try to play for a negative Pure Sabacc. The approximate likelihood of achieving a hand value of -23 is easily given by 

```{r}
neg_sabacc <- count(tot, val == -27)

prob_neg_sabacc <- neg_sabacc[2, 2]/uplim

prob_neg_sabacc
```

Third - since **these distributions are applicable to every player at the table**, you can use this information to predict other player's hand value. The best part? *A Sabacc shift is just resampling of the same number of cards without replacement.* This means that even if (perhaps *especially* if) a Sabacc shift occurs, you can still estimate the value of an opponent player's hand based on the number of cards they're holding.